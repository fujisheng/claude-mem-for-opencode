# Claude-Mem æ’ä»¶è‡ªåŠ¨å®‰è£…é…ç½®
# ç”¨äºŽ AI è‡ªåŠ¨é›†æˆä¸Šæ¸¸ claude-mem åˆ° Opencode

# =============================================================================
# ðŸŽ¯ ç›®æ ‡
# =============================================================================
# æœ¬é…ç½®æŒ‡å¯¼ AI è‡ªåŠ¨å®Œæˆä»¥ä¸‹å·¥ä½œï¼š
# 1. ä»Žä¸Šæ¸¸ä»“åº“æ‹‰å– claude-mem ä»£ç 
# 2. å®‰è£…å¿…è¦çš„ä¾èµ–ï¼ˆBunã€UVã€Node.jsï¼‰
# 3. æž„å»ºä¸Šæ¸¸é¡¹ç›®
# 4. é…ç½® Opencode MCP é›†æˆ
# 5. éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸ

# =============================================================================
# ðŸ“¦ ä¸Šæ¸¸ä¿¡æ¯
# =============================================================================
upstream:
  name: "claude-mem"
  repository: "https://github.com/thedotmack/claude-mem.git"
  version: "main"  # æˆ–æŒ‡å®š tagï¼Œå¦‚ "v9.1.1"
  install_path: ".opencode/plugins/claude-mem/vendor/claude-mem"
  
  # å¿…éœ€æ–‡ä»¶ï¼ˆå®‰è£…åŽå¿…é¡»å­˜åœ¨ï¼‰
  required_files:
    - "plugin/scripts/worker-service.cjs"
    - "plugin/scripts/worker-wrapper.cjs"
    - "plugin/scripts/mcp-server.cjs"
    - "package.json"
  
  # æž„å»ºäº§ç‰©ï¼ˆéœ€è¦æ‰§è¡Œ npm run build ç”Ÿæˆï¼‰
  build_outputs:
    - "plugin/scripts/worker-service.cjs"
    - "plugin/scripts/worker-wrapper.cjs"
    - "plugin/scripts/mcp-server.cjs"
    - "plugin/scripts/context-generator.cjs"

# =============================================================================
# ðŸ”§ ç³»ç»Ÿä¾èµ–
# =============================================================================
dependencies:
  # å¿…éœ€ï¼šè¿è¡Œæ—¶
  required:
    - name: "node"
      check_command: "node --version"
      min_version: "18.0.0"
      install_url: "https://nodejs.org/"
    
    - name: "bun"
      check_command: "bun --version"
      min_version: "1.0.0"
      install_script: |
        # Windows
        powershell -c "irm bun.sh/install.ps1|iex"
        # Linux/macOS
        # curl -fsSL https://bun.sh/install | bash
    
    - name: "uv"
      check_command: "uv --version"
      install_script: |
        # Windows
        powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
        # Linux/macOS
        # curl -LsSf https://astral.sh/uv/install.sh | sh
  
  # å¯é€‰ï¼šå¼€å‘æ—¶
  optional:
    - name: "git"
      check_command: "git --version"
      note: "ç”¨äºŽæ›´æ–°ä¸Šæ¸¸ä»£ç "

# =============================================================================
# ðŸ“ ç›®å½•ç»“æž„
# =============================================================================
# å®‰è£…åŽçš„ç›®å½•ç»“æž„åº”è¯¥æ˜¯ï¼š
#
# .opencode/plugins/claude-mem/
# â”œâ”€â”€ src/                          # æœ¬åœ°é€‚é…ä»£ç ï¼ˆå·²å­˜åœ¨ï¼‰
# â”‚   â”œâ”€â”€ index.ts                  # ä¸»å…¥å£
# â”‚   â”œâ”€â”€ services/                 # æœåŠ¡å±‚
# â”‚   â”œâ”€â”€ storage/                  # å­˜å‚¨å±‚
# â”‚   â””â”€â”€ types/                    # ç±»åž‹å®šä¹‰
# â”œâ”€â”€ vendor/                       # â† ä¸Šæ¸¸ä»£ç å®‰è£…åˆ°è¿™é‡Œ
# â”‚   â””â”€â”€ claude-mem/               # â† ä¸Šæ¸¸ä»“åº“
# â”‚       â”œâ”€â”€ plugin/
# â”‚       â”‚   â””â”€â”€ scripts/          # â† Worker è„šæœ¬
# â”‚       â”‚       â”œâ”€â”€ worker-service.cjs
# â”‚       â”‚       â”œâ”€â”€ worker-wrapper.cjs
# â”‚       â”‚       â””â”€â”€ mcp-server.cjs
# â”‚       â”œâ”€â”€ src/                  # ä¸Šæ¸¸æºç 
# â”‚       â”œâ”€â”€ package.json
# â”‚       â””â”€â”€ ...
# â”œâ”€â”€ .opencode/
# â”‚   â””â”€â”€ claude-mem-setup.yaml     # â† æœ¬æ–‡ä»¶
# â”œâ”€â”€ README.md
# â””â”€â”€ COMPATIBILITY.md

# =============================================================================
# ðŸš€ å®‰è£…æ­¥éª¤
# =============================================================================
installation:
  steps:
    # æ­¥éª¤ 1: æ£€æŸ¥ä¾èµ–
    - name: "æ£€æŸ¥ç³»ç»Ÿä¾èµ–"
      type: "check_dependencies"
      critical: true
      actions:
        - check: "node --version"
          fail_message: "éœ€è¦ Node.js 18+ï¼Œè¯·è®¿é—® https://nodejs.org/ å®‰è£…"
        - check: "bun --version"
          warn_message: "å»ºè®®å®‰è£… Bun ä»¥èŽ·å¾—æ›´å¥½æ€§èƒ½ï¼Œè®¿é—® https://bun.sh/"
      
    # æ­¥éª¤ 2: åˆ›å»ºç›®å½•
    - name: "åˆ›å»ºç›®å½•ç»“æž„"
      type: "create_directories"
      directories:
        - "{{install_path}}"
      
    # æ­¥éª¤ 3: æ‹‰å–ä¸Šæ¸¸ä»£ç 
    - name: "æ‹‰å–ä¸Šæ¸¸ä»£ç "
      type: "clone_or_update"
      source: "{{upstream.repository}}"
      target: "{{upstream.install_path}}"
      branch: "{{upstream.version}}"
      
    # æ­¥éª¤ 4: å®‰è£…ä¾èµ–
    - name: "å®‰è£…ä¸Šæ¸¸ä¾èµ–"
      type: "npm_install"
      working_dir: "{{upstream.install_path}}"
      command: "npm install"
      
    # æ­¥éª¤ 5: æž„å»ºä¸Šæ¸¸
    - name: "æž„å»ºä¸Šæ¸¸é¡¹ç›®"
      type: "build"
      working_dir: "{{upstream.install_path}}"
      command: "npm run build"
      timeout: 120000  # 2åˆ†é’Ÿ
      
    # æ­¥éª¤ 6: éªŒè¯æž„å»ºäº§ç‰©
    - name: "éªŒè¯æž„å»ºäº§ç‰©"
      type: "verify_files"
      files: "{{upstream.build_outputs}}"
      base_path: "{{upstream.install_path}}"
      
    # æ­¥éª¤ 7: é…ç½® MCP
    - name: "é…ç½® MCP æœåŠ¡å™¨"
      type: "configure_mcp"
      mcp_config_path: ".opencode/skills/mem-search/mcp.json"
      config:
        mcpServers:
          mem-search:
            command: "node"
            args:
              - "{{bootstrap_script_path}}"
            env:
              CLAUDE_MEM_WORKER_HOST: "127.0.0.1"
              CLAUDE_MEM_WORKER_PORT: "37777"
            enabled: true
            
    # æ­¥éª¤ 8: æœ€ç»ˆéªŒè¯
    - name: "æœ€ç»ˆéªŒè¯"
      type: "verify_installation"
      tests:
        - name: "æ£€æŸ¥ Worker è„šæœ¬å­˜åœ¨"
          file_exists: "{{upstream.install_path}}/plugin/scripts/worker-service.cjs"
        - name: "æ£€æŸ¥ MCP é…ç½®"
          file_exists: ".opencode/skills/mem-search/mcp.json"

# =============================================================================
# ðŸ”„ æ›´æ–°æ­¥éª¤
# =============================================================================
update:
  steps:
    # æ­¥éª¤ 1: æ‹‰å–æœ€æ–°ä»£ç 
    - name: "æ‹‰å–ä¸Šæ¸¸æ›´æ–°"
      type: "pull"
      working_dir: "{{upstream.install_path}}"
      command: "git pull origin {{upstream.version}}"
      
    # æ­¥éª¤ 2: é‡æ–°å®‰è£…ä¾èµ–
    - name: "æ›´æ–°ä¾èµ–"
      type: "npm_install"
      working_dir: "{{upstream.install_path}}"
      command: "npm install"
      
    # æ­¥éª¤ 3: é‡æ–°æž„å»º
    - name: "é‡æ–°æž„å»º"
      type: "build"
      working_dir: "{{upstream.install_path}}"
      command: "npm run build"
      timeout: 120000
      
    # æ­¥éª¤ 4: é‡å¯ Worker
    - name: "é‡å¯ Worker æœåŠ¡"
      type: "restart_service"
      note: "éœ€è¦æ‰‹åŠ¨é‡å¯ MCP æœåŠ¡å™¨ä»¥ä½¿ç”¨æ–°ç‰ˆæœ¬"

# =============================================================================
# âœ… éªŒè¯æ£€æŸ¥æ¸…å•
# =============================================================================
verification:
  checks:
    # æ–‡ä»¶æ£€æŸ¥
    files:
      - path: "vendor/claude-mem/plugin/scripts/worker-service.cjs"
        description: "Worker æœåŠ¡ä¸»è„šæœ¬"
      - path: "vendor/claude-mem/plugin/scripts/worker-wrapper.cjs"
        description: "Worker åŒ…è£…å™¨"
      - path: "vendor/claude-mem/plugin/scripts/mcp-server.cjs"
        description: "MCP æœåŠ¡å™¨è„šæœ¬"
    
    # åŠŸèƒ½æµ‹è¯•
    tests:
      - name: "Worker å¥åº·æ£€æŸ¥"
        type: "http"
        url: "http://127.0.0.1:37777/api/health"
        expected_status: 200
        
      - name: "MCP å·¥å…·å¯ç”¨"
        type: "mcp_tool"
        tool: "search"
        test_query: "test"
        
    # é…ç½®æ£€æŸ¥
    config:
      - file: ".opencode/skills/mem-search/mcp.json"
        must_contain: "mem-search"

# =============================================================================
# ðŸ“‹ AI æ‰§è¡ŒæŒ‡å—
# =============================================================================
ai_execution_guide:
  # é¦–æ¬¡å®‰è£…æ—¶æ‰§è¡Œ
  first_time_setup: |
    1. è¯»å–æœ¬é…ç½®æ–‡ä»¶
    2. æ£€æŸ¥ç³»ç»Ÿä¾èµ–ï¼ˆNode.jsã€Bunï¼‰
    3. å…‹éš†ä¸Šæ¸¸ä»“åº“åˆ°æŒ‡å®šè·¯å¾„
    4. åœ¨ä¸Šæ¸¸ç›®å½•æ‰§è¡Œ npm install
    5. åœ¨ä¸Šæ¸¸ç›®å½•æ‰§è¡Œ npm run build
    6. éªŒè¯æž„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
    7. ç¡®ä¿ MCP é…ç½®æ­£ç¡®
    8. è¿è¡ŒéªŒè¯æµ‹è¯•
    
  # æ—¥å¸¸ä½¿ç”¨æ—¶æ›´æ–°
  daily_update: |
    1. è¿›å…¥ä¸Šæ¸¸ç›®å½•
    2. æ‰§è¡Œ git pull origin main
    3. æ‰§è¡Œ npm install
    4. æ‰§è¡Œ npm run build
    5. æé†’ç”¨æˆ·é‡å¯ MCP æœåŠ¡å™¨
    
  # æ•…éšœæŽ’é™¤
  troubleshooting:
    - problem: "Worker æ— æ³•å¯åŠ¨"
      solution: |
        1. æ£€æŸ¥ 37777 ç«¯å£æ˜¯å¦è¢«å ç”¨
        2. æ£€æŸ¥ Bun æ˜¯å¦å·²å®‰è£…
        3. æ£€æŸ¥ worker-service.cjs æ˜¯å¦å­˜åœ¨
        4. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ ~/.claude-mem/logs/
        
    - problem: "MCP å·¥å…·è°ƒç”¨å¤±è´¥"
      solution: |
        1. æ£€æŸ¥ mcp.json é…ç½®è·¯å¾„æ˜¯å¦æ­£ç¡®
        2. æ£€æŸ¥ bootstrap.cjs æ˜¯å¦å­˜åœ¨
        3. æ£€æŸ¥ Worker æ˜¯å¦æ­£åœ¨è¿è¡Œ
        4. å°è¯•é‡å¯ MCP æœåŠ¡å™¨
        
    - problem: "æž„å»ºå¤±è´¥"
      solution: |
        1. åˆ é™¤ node_modules å¹¶é‡æ–° npm install
        2. æ£€æŸ¥ Node.js ç‰ˆæœ¬æ˜¯å¦ >= 18
        3. æ£€æŸ¥æ˜¯å¦æœ‰æƒé™é—®é¢˜

# =============================================================================
# ðŸ“ ç‰ˆæœ¬è®°å½•
# =============================================================================
version: "1.0.0"
last_updated: "2026-02-10"
compatible_with:
  - "opencode >= 1.0"
  - "claude-mem >= 9.0"

# =============================================================================
# ðŸ”— ç›¸å…³é“¾æŽ¥
# =============================================================================
references:
  upstream_repo: "https://github.com/thedotmack/claude-mem"
  upstream_docs: "https://docs.claude-mem.ai"
  opencode_docs: "https://opencode.ai/docs"
  issue_tracker: "https://github.com/thedotmack/claude-mem/issues"
